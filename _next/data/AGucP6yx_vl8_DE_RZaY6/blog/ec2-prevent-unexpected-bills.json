{"pageProps":{"post":{"title":"EC2 instances and how to prevent unexpected bills","date":"2019-02-11","content":"\nThe benefits of [Cloud Computing](https://aws.amazon.com/what-is-cloud-computing/) and on-demand computing environments are pretty well known.\n\nOne such service is [EC2](https://aws.amazon.com/ec2/) from Amazon, which allows business subscribers to run application programs in the computing environment. The EC2 serves as an almost unlimited set of virtual machines.\n\nThis is a great service for just a few dollars a day. However, sometimes due to a simple oversight we can be burdened with large unexpected bills by forgetting to shut down a virtual server.\n\n## Running an EC2 instance\n\nAs developers, we sometimes need to run an EC2 instance to run some temporary workloads. We do this because these workloads need more resources than what’s available on our developer machine. It’s generally for a process that needs a massive amount of RAM, like when testing data transformation for an in-memory database.\n\nIt’s amazing that we have such massive compute power on-demand for a few dollars a day. However, sometimes those few dollars a day, can become a headache at the end of the month.\n\nWe might need the big instance for four or five hours work. We complete the job, validate the results and congratulate ourselves on a job well done. But, we go home and forget to stop the instance.\n\nThis can result in the aforementioned unexpected bills.\n\n## Preventing unexpected bills with EC2\n\nWhat would be the simplest way to resolve this without investing too much time and effort into it?\n\nCould we launch a self-stopping instance?\n\nA search led us to [this Stack Overflow answer](https://stackoverflow.com/a/38186787/125629):\n\n$ echo '#!/bin/sh' > per-boot.sh\n$ echo 'echo \"halt\" | at now + 1 hour' >> per-boot.sh\n$ echo 'echo per-boot: \\`date\\` >> /tmp/per-boot.txt' >> per-boot.sh\n$ chmod +x per-boot.sh\n$ sudo chown -R root per-boot.sh\n$ sudo mv -viu per-boot.sh /var/lib/cloud/scripts/per-boot\n\nThis introduced us to [Cloud-Init](https://cloudinit.readthedocs.io/en/latest/) “the defacto multi-distribution package that handles early initialization of a cloud instance.”\n\nAn investigation into Cloud-Init and [EC2 User-Data](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/user-data.html) led us to our solution.  Use the following as the instance User-Data before launching the instance:\n\n#cloud-config\ncloud\\_final\\_modules:\n- \\[scripts-user, always\\]\nruncmd:\n- 'echo \"per-boot start: \\`date\\`\" >> /tmp/per-boot.txt'\n- 'echo \"sudo shutdown now\" | at now + 1 hour'\n\nThe first `runcmd` runs every time the instance is booted and appends a timestamp to a simple log file. By inspecting this file, you'll be able to see how many times the instance has been started, and you can easily see the last time it started too.\n\nThe second `runcmd` schedules the `shutdown` command to run in one hours time. We’re using the [at command](https://www.computerhope.com/unix/uat.htm) to schedule the call. This is a very versatile command and gives you plenty of scope to tailor how long you want your instance to run.\n\nWe have tested this `User-Data` on Ubuntu 16.10 and Amazon Linux 2 images. For it to work on Debian 9 you will need to have the \\`at\\` command installed so an additional \\`runcmd\\` is needed:\n\n\\- 'apt-get install -y at'\n\nHopefully, this is straight-forward enough to save forgetful humans (like me) some money.\n\nJohn Keyes\n\nServer Side Developer\n","postImage":"https://cdn-bhcgp.nitrocdn.com/lQsUIlYWTGkhjqgYKmLJkHSBczAwGDPM/assets/static/optimized/rev-f8d7f54/wp-content/uploads/2019/01/sam-truong-dan-627874-unsplash.jpg.webp"}},"__N_SSG":true}