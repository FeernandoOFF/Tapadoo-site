<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><title>Blog | Tapadoo </title><meta name="next-head-count" content="3"/><link rel="preload" href="/Tapadoo-site/_next/static/css/8864096090b81163.css" as="style"/><link rel="stylesheet" href="/Tapadoo-site/_next/static/css/8864096090b81163.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/Tapadoo-site/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/Tapadoo-site/_next/static/chunks/webpack-461e027a94344cdf.js" defer=""></script><script src="/Tapadoo-site/_next/static/chunks/framework-715a76d8b0695da7.js" defer=""></script><script src="/Tapadoo-site/_next/static/chunks/main-baed5792d4d394cf.js" defer=""></script><script src="/Tapadoo-site/_next/static/chunks/pages/_app-c68c249bf95195e7.js" defer=""></script><script src="/Tapadoo-site/_next/static/chunks/996-f765e51b6a74c60f.js" defer=""></script><script src="/Tapadoo-site/_next/static/chunks/pages/blog/%5Bslug%5D-76e369896f8b1138.js" defer=""></script><script src="/Tapadoo-site/_next/static/JwEOORDbTBDoM01zxIuTP/_buildManifest.js" defer=""></script><script src="/Tapadoo-site/_next/static/JwEOORDbTBDoM01zxIuTP/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="bg-base-100 shadow-sm"><header class="navbar max-w-7xl mx-auto "><div class="navbar-start"><img src="/Tapadoo-site/_next/static/media/tapadoo-large-logo.b51a8a63.png" alt="Tapadoo logo" class="w-full max-w-[120px] cursor-pointer"/></div><div class="navbar-end md:hidden flex"><div class="dropdown dropdown-left"><label tabindex="0" class="btn btn-ghost lg:hidden"><button><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2 6C2 5.44772 2.44772 5 3 5H21C21.5523 5 22 5.44772 22 6C22 6.55228 21.5523 7 21 7H3C2.44772 7 2 6.55228 2 6Z" fill="currentColor"></path><path d="M2 12.0322C2 11.4799 2.44772 11.0322 3 11.0322H21C21.5523 11.0322 22 11.4799 22 12.0322C22 12.5845 21.5523 13.0322 21 13.0322H3C2.44772 13.0322 2 12.5845 2 12.0322Z" fill="currentColor"></path><path d="M3 17.0645C2.44772 17.0645 2 17.5122 2 18.0645C2 18.6167 2.44772 19.0645 3 19.0645H21C21.5523 19.0645 22 18.6167 22 18.0645C22 17.5122 21.5523 17.0645 21 17.0645H3Z" fill="currentColor"></path></svg></button></label><ul class="menu menu-compact dropdown-content mt-3 p-2 shadow bg-base-100 rounded-box w-52"><li><a class="font-semibold  " href="/Tapadoo-site/tapadoo/about">Tapadoo</a><a class=" border my-2  border-transparent" href="/Tapadoo-site/tapadoo/about">Who are you?</a><a class=" border my-2  border-transparent" href="/Tapadoo-site/tapadoo/localization">Where are you based?</a><a class=" border my-2  border-transparent" href="/Tapadoo-site/tapadoo/work">Who do you work with?</a><a class=" border my-2  border-transparent" href="/Tapadoo-site/tapadoo/careers">Are you hiring?</a><a class=" border my-2  border-transparent" href="/Tapadoo-site/tapadoo/contact">Get in touch</a></li><li><a class="font-semibold  " href="/Tapadoo-site/apps/requisites">Apps</a><a class=" border my-2  border-transparent" href="/Tapadoo-site/apps/requisites">Do I need an app?</a><a class=" border my-2  border-transparent" href="/Tapadoo-site/apps/costs">How much does an app cost?</a><a class=" border my-2  border-transparent" href="/Tapadoo-site/apps/success-cases">Case Studies</a><a class=" border my-2  border-transparent" href="/Tapadoo-site/apps/process">Process</a></li><li><a class="font-semibold  " href="/Tapadoo-site/blog">Blog</a></li></ul></div></div><div class="navbar-end hidden md:flex"><ul class="menu menu-horizontal p-0"><li><a class="  " href="/Tapadoo-site/tapadoo/about">Tapadoo</a></li><li><a class="  " href="/Tapadoo-site/apps/requisites">Apps</a></li><li><a class="  " href="/Tapadoo-site/blog">Blog</a></li></ul></div></header></div><main class="min-h-[70vh]"> <div><img src="https://cdn-bhcgp.nitrocdn.com/lQsUIlYWTGkhjqgYKmLJkHSBczAwGDPM/assets/static/optimized/rev-f8d7f54/wp-content/uploads/2019/02/abstract_3.png.webp" alt=""/><p>Animating Custom CALayer Properties in Swift - And What To Check For When They Aren’t Working</p><p>
![iOS UI showing a circle filling up in slices.](images/layer-spin-1.gif)

Custom CALayer progress indicator

Creating custom CALayers in your iOS apps can be very useful, and animating them can add some polish to the final result. CALayers are everywhere in UIKit - every UIView has a layer to draw its contents on. Layers have been around forever, and you’ll find many existing posts on animating them, such as [https://blog.codecentric.de/en/2016/07/custom-property-uiview-block-animation/](https://blog.codecentric.de/en/2016/07/custom-property-uiview-block-animation/) or [https://www.objc.io/issues/12-animations/animating-custom-layer-properties/](https://www.objc.io/issues/12-animations/animating-custom-layer-properties/)

This post is not a full guide on how to animate your CALayers, instead I want to highlight something very simple that might cause you issues, as it did for me. If anything, this might trip up those developers coming from Objective C development even more, as if you are like me you&#x27;ve animated many layers over the years and thought you knew all the tricks.

## The Problem

So you&#x27;ve created a custom CALayer, in swift this time, and you are pretty sure you&#x27;ve done everything. You have your init method to initialise with another layer. You have displayForKey implemented. You&#x27;ve even added the actionForKey method incase you want to try some implicit animations. You&#x27;ve impemented your custom drawing. And your layer works! It&#x27;s in a view, it has a frame, you set your properties, display the layer and the content appears.

However, it doesn&#x27;t animate. You create a CABasicAnimation, set the name of the property, double checked the spelling, but no animations.

Perhaps you have something like this:

```
class LoadingLayer: CALayer {
    
    var tintColor: UIColor? = UIColor.black
    var percentage: CGFloat = 0
    
    override init() {
        super.init()
    }
    
    override init(layer: Any) {
 
        if let other = layer as? LoadingLayer {
            self.tintColor = other.tintColor
            self.percentage = other.percentage
        }
        else {
            fatalError()
        }
        
        super.init(layer: layer)
    }

    required init?(coder aDecoder: NSCoder) {
        super.init(coder: aDecoder)
    }
    
    override func draw(in ctx: CGContext) {
        let center = CGPoint(x: self.bounds.width/2.0, y: self.bounds.height/2.0)
        
        let radius = (self.bounds.width*0.9)/2.0
        let fillColor = self.tintColor ?? UIColor.black
        
        ctx.setStrokeColor(UIColor.black.cgColor)
        ctx.setFillColor(fillColor.cgColor)
        
        ctx.beginPath()
        ctx.translateBy(x: center.x, y: center.y)
        ctx.rotate(by: -.pi/2.0)
        
        ctx.move(to: CGPoint(x: 0, y: 0))
        ctx.addArc(center: CGPoint(x: 0, y: 0),
                   radius: radius,
                   startAngle: 0,
                   endAngle: (2*CGFloat.pi)*self.percentage,
                   clockwise: false)
        
        ctx.closePath()
        
        ctx.drawPath(using: .fill)
    }
    
    
    override class func needsDisplay(forKey key: String) -&gt; Bool {
        if key == &quot;percentage&quot; {
            return true
        }
        
        return super.needsDisplay(forKey: key)
    }
    
    override func action(forKey event: String) -&gt; CAAction? {
        
        if event == &quot;percentage&quot; {
            let anim = CABasicAnimation(keyPath: &quot;percentage&quot;)
            anim.byValue = 0.01
            anim.timingFunction = CAMediaTimingFunction(name: .linear)
            anim.fromValue = presentation()?.percentage ?? 0
            return anim
        }
        return super.action(forKey: event)
    }
}
```

This works fine when setting the property and drawing once, but when you animate like below, nothing happens:

```
let anim = CABasicAnimation(keyPath: &quot;percentage&quot;)
anim.fromValue = 0
anim.toValue =  1.0
anim.byValue = 0.01
anim.duration = 2.0
anim.repeatCount = MAXFLOAT
        
loadingLayer.add(anim, forKey: &quot;spin&quot;)
```

Maybe you even look at some old Objective-C code, and see no difference.

## The Solution

The fix is as follows: Make sure the property you are trying to animate is accessible from Objective-C by adding `@objc` in the declaration like so. Maybe even make it dynamic for some other CALayer bonuses like not needing to copy its value during init:

```
@objc dynamic var percentage: CGFloat = 0﻿
```

Now your animation should be working. It’s a small thing thats easy to forget.

This does highlight something else however - another bad habit in here. In the needsDisplay function, and the CABasicAnimation the percentage key is used as a literal string. One way to add some additional safety to your custom CALayer code and animations would be to use the `#keyPath` feature of swift to create that string for us. With two advantages - if we rename the property later xcode will point out where we need to change it. And it will also warn you if your property isn’t accessbile from Objective-C with a warning like the following:

```
error: CALayerAnimationExample.playground:52:41: error: argument of &#x27;#keyPath&#x27; refers to non-&#x27;@objc&#x27; property &#x27;percentage&#x27;
        if key == #keyPath(LoadingLayer.percentage) {
                                        ^

CALayerAnimationExample.playground:2:9: note: add &#x27;@objc&#x27; to expose this var to Objective-C
    var percentage: CGFloat = 0
```

So remembering to use `#keyPath` instead of literal strings might help catch this error sooner.  

A playground example containing this sample CALayer and View can be found on github here: [https://github.com/Tapadoo/CALayerAnimationPlayground](https://github.com/Tapadoo/CALayerAnimationPlayground)

Jason Connery

Lead iOS Developer
<!-- --> </p></div> </main><footer class="p-10 bg-[#F5F5F590] text-[#A09893] "><div class="app-container footer"><div><img src="/Tapadoo-site/_next/static/media/tapadoo-large-logo.b51a8a63.png" alt="Tapadoo logo" class="w-full max-w-[120px] cursor-pointer grayscale"/><div class="my-4"><p>26-28 Strand Street Great, Dublin 1 </p><a href="mailto:enquiries@tapadoo.com">enquiries@tapadoo.com</a></div><a href="tel:3531123456">+353 1 123456</a></div><div><span class="footer-title">Links</span><a class="link link-hover" href="/Tapadoo-site/tapadoo/contact">Privacy Policy</a><a class="link link-hover" href="/Tapadoo-site/tapadoo/contact">Support</a></div><div><span class="footer-title">Company</span><a class="link link-hover" href="/Tapadoo-site/tapadoo/about">About us</a><a class="link link-hover" href="/Tapadoo-site/tapadoo/careers">Careers</a><a class="link link-hover" href="/Tapadoo-site/apps/costs">Pricing</a><a class="link link-hover" href="/Tapadoo-site/blog">Blog</a></div></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"Animating Custom CALayer Properties in Swift - And What To Check For When They Aren’t Working","date":"2019-02-05","content":"\n![iOS UI showing a circle filling up in slices.](images/layer-spin-1.gif)\n\nCustom CALayer progress indicator\n\nCreating custom CALayers in your iOS apps can be very useful, and animating them can add some polish to the final result. CALayers are everywhere in UIKit - every UIView has a layer to draw its contents on. Layers have been around forever, and you’ll find many existing posts on animating them, such as [https://blog.codecentric.de/en/2016/07/custom-property-uiview-block-animation/](https://blog.codecentric.de/en/2016/07/custom-property-uiview-block-animation/) or [https://www.objc.io/issues/12-animations/animating-custom-layer-properties/](https://www.objc.io/issues/12-animations/animating-custom-layer-properties/)\n\nThis post is not a full guide on how to animate your CALayers, instead I want to highlight something very simple that might cause you issues, as it did for me. If anything, this might trip up those developers coming from Objective C development even more, as if you are like me you've animated many layers over the years and thought you knew all the tricks.\n\n## The Problem\n\nSo you've created a custom CALayer, in swift this time, and you are pretty sure you've done everything. You have your init method to initialise with another layer. You have displayForKey implemented. You've even added the actionForKey method incase you want to try some implicit animations. You've impemented your custom drawing. And your layer works! It's in a view, it has a frame, you set your properties, display the layer and the content appears.\n\nHowever, it doesn't animate. You create a CABasicAnimation, set the name of the property, double checked the spelling, but no animations.\n\nPerhaps you have something like this:\n\n```\nclass LoadingLayer: CALayer {\n    \n    var tintColor: UIColor? = UIColor.black\n    var percentage: CGFloat = 0\n    \n    override init() {\n        super.init()\n    }\n    \n    override init(layer: Any) {\n \n        if let other = layer as? LoadingLayer {\n            self.tintColor = other.tintColor\n            self.percentage = other.percentage\n        }\n        else {\n            fatalError()\n        }\n        \n        super.init(layer: layer)\n    }\n\n    required init?(coder aDecoder: NSCoder) {\n        super.init(coder: aDecoder)\n    }\n    \n    override func draw(in ctx: CGContext) {\n        let center = CGPoint(x: self.bounds.width/2.0, y: self.bounds.height/2.0)\n        \n        let radius = (self.bounds.width*0.9)/2.0\n        let fillColor = self.tintColor ?? UIColor.black\n        \n        ctx.setStrokeColor(UIColor.black.cgColor)\n        ctx.setFillColor(fillColor.cgColor)\n        \n        ctx.beginPath()\n        ctx.translateBy(x: center.x, y: center.y)\n        ctx.rotate(by: -.pi/2.0)\n        \n        ctx.move(to: CGPoint(x: 0, y: 0))\n        ctx.addArc(center: CGPoint(x: 0, y: 0),\n                   radius: radius,\n                   startAngle: 0,\n                   endAngle: (2*CGFloat.pi)*self.percentage,\n                   clockwise: false)\n        \n        ctx.closePath()\n        \n        ctx.drawPath(using: .fill)\n    }\n    \n    \n    override class func needsDisplay(forKey key: String) -\u003e Bool {\n        if key == \"percentage\" {\n            return true\n        }\n        \n        return super.needsDisplay(forKey: key)\n    }\n    \n    override func action(forKey event: String) -\u003e CAAction? {\n        \n        if event == \"percentage\" {\n            let anim = CABasicAnimation(keyPath: \"percentage\")\n            anim.byValue = 0.01\n            anim.timingFunction = CAMediaTimingFunction(name: .linear)\n            anim.fromValue = presentation()?.percentage ?? 0\n            return anim\n        }\n        return super.action(forKey: event)\n    }\n}\n```\n\nThis works fine when setting the property and drawing once, but when you animate like below, nothing happens:\n\n```\nlet anim = CABasicAnimation(keyPath: \"percentage\")\nanim.fromValue = 0\nanim.toValue =  1.0\nanim.byValue = 0.01\nanim.duration = 2.0\nanim.repeatCount = MAXFLOAT\n        \nloadingLayer.add(anim, forKey: \"spin\")\n```\n\nMaybe you even look at some old Objective-C code, and see no difference.\n\n## The Solution\n\nThe fix is as follows: Make sure the property you are trying to animate is accessible from Objective-C by adding `@objc` in the declaration like so. Maybe even make it dynamic for some other CALayer bonuses like not needing to copy its value during init:\n\n```\n@objc dynamic var percentage: CGFloat = 0﻿\n```\n\nNow your animation should be working. It’s a small thing thats easy to forget.\n\nThis does highlight something else however - another bad habit in here. In the needsDisplay function, and the CABasicAnimation the percentage key is used as a literal string. One way to add some additional safety to your custom CALayer code and animations would be to use the `#keyPath` feature of swift to create that string for us. With two advantages - if we rename the property later xcode will point out where we need to change it. And it will also warn you if your property isn’t accessbile from Objective-C with a warning like the following:\n\n```\nerror: CALayerAnimationExample.playground:52:41: error: argument of '#keyPath' refers to non-'@objc' property 'percentage'\n        if key == #keyPath(LoadingLayer.percentage) {\n                                        ^\n\nCALayerAnimationExample.playground:2:9: note: add '@objc' to expose this var to Objective-C\n    var percentage: CGFloat = 0\n```\n\nSo remembering to use `#keyPath` instead of literal strings might help catch this error sooner.  \n\nA playground example containing this sample CALayer and View can be found on github here: [https://github.com/Tapadoo/CALayerAnimationPlayground](https://github.com/Tapadoo/CALayerAnimationPlayground)\n\nJason Connery\n\nLead iOS Developer\n","postImage":"https://cdn-bhcgp.nitrocdn.com/lQsUIlYWTGkhjqgYKmLJkHSBczAwGDPM/assets/static/optimized/rev-f8d7f54/wp-content/uploads/2019/02/abstract_3.png.webp","categories":["development","iphonedev"],"tags":["animation","ios"]}},"__N_SSG":true},"page":"/blog/[slug]","query":{"slug":"animating-custom-calayer-properties-in-swift-and-what-to-check-for-when-they-arent-working"},"buildId":"JwEOORDbTBDoM01zxIuTP","assetPrefix":"/Tapadoo-site","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>