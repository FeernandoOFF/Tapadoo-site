<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><title>Blog | Tapadoo </title><link rel="preconnect" href="https://fonts.googleapis.com"/><link rel="preconnect" href="https://fonts.gstatic.com"/><meta name="next-head-count" content="6"/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin /><link rel="preload" href="/Tapadoo-site/_next/static/css/94d46e1b9564407b.css" as="style"/><link rel="stylesheet" href="/Tapadoo-site/_next/static/css/94d46e1b9564407b.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/Tapadoo-site/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/Tapadoo-site/_next/static/chunks/webpack-461e027a94344cdf.js" defer=""></script><script src="/Tapadoo-site/_next/static/chunks/framework-715a76d8b0695da7.js" defer=""></script><script src="/Tapadoo-site/_next/static/chunks/main-baed5792d4d394cf.js" defer=""></script><script src="/Tapadoo-site/_next/static/chunks/pages/_app-c68c249bf95195e7.js" defer=""></script><script src="/Tapadoo-site/_next/static/chunks/996-f765e51b6a74c60f.js" defer=""></script><script src="/Tapadoo-site/_next/static/chunks/402-0ad10abf6b47b5c8.js" defer=""></script><script src="/Tapadoo-site/_next/static/chunks/249-966c4d96ba6f0ec8.js" defer=""></script><script src="/Tapadoo-site/_next/static/chunks/pages/blog/post/%5Bslug%5D-fddea86d5cd85433.js" defer=""></script><script src="/Tapadoo-site/_next/static/TlZmfFUIyTMTk-qJxhjn1/_buildManifest.js" defer=""></script><script src="/Tapadoo-site/_next/static/TlZmfFUIyTMTk-qJxhjn1/_ssgManifest.js" defer=""></script><style data-href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100;300;400;500;600;700&display=swap">@font-face{font-family:'Montserrat';font-style:normal;font-weight:100;font-display:swap;src:url(https://fonts.gstatic.com/s/montserrat/v25/JTUHjIg1_i6t8kCHKm4532VJOt5-QNFgpCtr6Uw9.woff) format('woff')}@font-face{font-family:'Montserrat';font-style:normal;font-weight:300;font-display:swap;src:url(https://fonts.gstatic.com/s/montserrat/v25/JTUHjIg1_i6t8kCHKm4532VJOt5-QNFgpCs16Ew9.woff) format('woff')}@font-face{font-family:'Montserrat';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/montserrat/v25/JTUHjIg1_i6t8kCHKm4532VJOt5-QNFgpCtr6Ew9.woff) format('woff')}@font-face{font-family:'Montserrat';font-style:normal;font-weight:500;font-display:swap;src:url(https://fonts.gstatic.com/s/montserrat/v25/JTUHjIg1_i6t8kCHKm4532VJOt5-QNFgpCtZ6Ew9.woff) format('woff')}@font-face{font-family:'Montserrat';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/montserrat/v25/JTUHjIg1_i6t8kCHKm4532VJOt5-QNFgpCu170w9.woff) format('woff')}@font-face{font-family:'Montserrat';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/montserrat/v25/JTUHjIg1_i6t8kCHKm4532VJOt5-QNFgpCuM70w9.woff) format('woff')}@font-face{font-family:'Montserrat';font-style:normal;font-weight:100;font-display:swap;src:url(https://fonts.gstatic.com/s/montserrat/v25/JTUSjIg1_i6t8kCHKm459WRhyyTh89ZNpQ.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Montserrat';font-style:normal;font-weight:100;font-display:swap;src:url(https://fonts.gstatic.com/s/montserrat/v25/JTUSjIg1_i6t8kCHKm459W1hyyTh89ZNpQ.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Montserrat';font-style:normal;font-weight:100;font-display:swap;src:url(https://fonts.gstatic.com/s/montserrat/v25/JTUSjIg1_i6t8kCHKm459WZhyyTh89ZNpQ.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Montserrat';font-style:normal;font-weight:100;font-display:swap;src:url(https://fonts.gstatic.com/s/montserrat/v25/JTUSjIg1_i6t8kCHKm459WdhyyTh89ZNpQ.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Montserrat';font-style:normal;font-weight:100;font-display:swap;src:url(https://fonts.gstatic.com/s/montserrat/v25/JTUSjIg1_i6t8kCHKm459WlhyyTh89Y.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Montserrat';font-style:normal;font-weight:300;font-display:swap;src:url(https://fonts.gstatic.com/s/montserrat/v25/JTUSjIg1_i6t8kCHKm459WRhyyTh89ZNpQ.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Montserrat';font-style:normal;font-weight:300;font-display:swap;src:url(https://fonts.gstatic.com/s/montserrat/v25/JTUSjIg1_i6t8kCHKm459W1hyyTh89ZNpQ.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Montserrat';font-style:normal;font-weight:300;font-display:swap;src:url(https://fonts.gstatic.com/s/montserrat/v25/JTUSjIg1_i6t8kCHKm459WZhyyTh89ZNpQ.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Montserrat';font-style:normal;font-weight:300;font-display:swap;src:url(https://fonts.gstatic.com/s/montserrat/v25/JTUSjIg1_i6t8kCHKm459WdhyyTh89ZNpQ.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Montserrat';font-style:normal;font-weight:300;font-display:swap;src:url(https://fonts.gstatic.com/s/montserrat/v25/JTUSjIg1_i6t8kCHKm459WlhyyTh89Y.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Montserrat';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/montserrat/v25/JTUSjIg1_i6t8kCHKm459WRhyyTh89ZNpQ.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Montserrat';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/montserrat/v25/JTUSjIg1_i6t8kCHKm459W1hyyTh89ZNpQ.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Montserrat';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/montserrat/v25/JTUSjIg1_i6t8kCHKm459WZhyyTh89ZNpQ.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Montserrat';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/montserrat/v25/JTUSjIg1_i6t8kCHKm459WdhyyTh89ZNpQ.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Montserrat';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/montserrat/v25/JTUSjIg1_i6t8kCHKm459WlhyyTh89Y.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Montserrat';font-style:normal;font-weight:500;font-display:swap;src:url(https://fonts.gstatic.com/s/montserrat/v25/JTUSjIg1_i6t8kCHKm459WRhyyTh89ZNpQ.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Montserrat';font-style:normal;font-weight:500;font-display:swap;src:url(https://fonts.gstatic.com/s/montserrat/v25/JTUSjIg1_i6t8kCHKm459W1hyyTh89ZNpQ.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Montserrat';font-style:normal;font-weight:500;font-display:swap;src:url(https://fonts.gstatic.com/s/montserrat/v25/JTUSjIg1_i6t8kCHKm459WZhyyTh89ZNpQ.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Montserrat';font-style:normal;font-weight:500;font-display:swap;src:url(https://fonts.gstatic.com/s/montserrat/v25/JTUSjIg1_i6t8kCHKm459WdhyyTh89ZNpQ.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Montserrat';font-style:normal;font-weight:500;font-display:swap;src:url(https://fonts.gstatic.com/s/montserrat/v25/JTUSjIg1_i6t8kCHKm459WlhyyTh89Y.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Montserrat';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/montserrat/v25/JTUSjIg1_i6t8kCHKm459WRhyyTh89ZNpQ.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Montserrat';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/montserrat/v25/JTUSjIg1_i6t8kCHKm459W1hyyTh89ZNpQ.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Montserrat';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/montserrat/v25/JTUSjIg1_i6t8kCHKm459WZhyyTh89ZNpQ.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Montserrat';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/montserrat/v25/JTUSjIg1_i6t8kCHKm459WdhyyTh89ZNpQ.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Montserrat';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/montserrat/v25/JTUSjIg1_i6t8kCHKm459WlhyyTh89Y.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Montserrat';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/montserrat/v25/JTUSjIg1_i6t8kCHKm459WRhyyTh89ZNpQ.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Montserrat';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/montserrat/v25/JTUSjIg1_i6t8kCHKm459W1hyyTh89ZNpQ.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Montserrat';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/montserrat/v25/JTUSjIg1_i6t8kCHKm459WZhyyTh89ZNpQ.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Montserrat';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/montserrat/v25/JTUSjIg1_i6t8kCHKm459WdhyyTh89ZNpQ.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Montserrat';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/montserrat/v25/JTUSjIg1_i6t8kCHKm459WlhyyTh89Y.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}</style></head><body><div id="__next"><div class="bg-base-100 shadow-sm z-50"><header class="navbar max-w-7xl mx-auto "><div class="navbar-start"><a href="/Tapadoo-site"><img src="/Tapadoo-site/_next/static/media/tapadoo-large-logo.b51a8a63.png" alt="Tapadoo logo" class="w-full max-w-[120px] cursor-pointer"/></a></div><div class="navbar-end md:hidden flex"><div class="dropdown dropdown-left"><label tabindex="0" class="btn btn-ghost lg:hidden"><button><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2 6C2 5.44772 2.44772 5 3 5H21C21.5523 5 22 5.44772 22 6C22 6.55228 21.5523 7 21 7H3C2.44772 7 2 6.55228 2 6Z" fill="currentColor"></path><path d="M2 12.0322C2 11.4799 2.44772 11.0322 3 11.0322H21C21.5523 11.0322 22 11.4799 22 12.0322C22 12.5845 21.5523 13.0322 21 13.0322H3C2.44772 13.0322 2 12.5845 2 12.0322Z" fill="currentColor"></path><path d="M3 17.0645C2.44772 17.0645 2 17.5122 2 18.0645C2 18.6167 2.44772 19.0645 3 19.0645H21C21.5523 19.0645 22 18.6167 22 18.0645C22 17.5122 21.5523 17.0645 21 17.0645H3Z" fill="currentColor"></path></svg></button></label><ul class="menu menu-compact dropdown-content mt-3 p-2 shadow bg-base-100 rounded-box w-52 z-50"><li><a class="font-semibold  " href="/Tapadoo-site/tapadoo/about">Tapadoo</a><a class=" border my-2  border-transparent" href="/Tapadoo-site/tapadoo/about">Who are you?</a><a class=" border my-2  border-transparent" href="/Tapadoo-site/tapadoo/localization">Where are you based?</a><a class=" border my-2  border-transparent" href="/Tapadoo-site/tapadoo/work">Who do you work with?</a><a class=" border my-2  border-transparent" href="/Tapadoo-site/tapadoo/careers">Are you hiring?</a><a class=" border my-2  border-transparent" href="/Tapadoo-site/tapadoo/contact">Get in touch</a></li><li><a class="font-semibold  " href="/Tapadoo-site/apps/requisites">Apps</a><a class=" border my-2  border-transparent" href="/Tapadoo-site/apps/requisites">Do I need an app?</a><a class=" border my-2  border-transparent" href="/Tapadoo-site/apps/costs">How much does an app cost?</a><a class=" border my-2  border-transparent" href="/Tapadoo-site/apps/success-cases">Case Studies</a><a class=" border my-2  border-transparent" href="/Tapadoo-site/apps/process">Process</a></li><li><a class="font-semibold  " href="/Tapadoo-site/blog/1">Blog</a></li></ul></div></div><div class="navbar-end hidden md:flex"><ul class="menu menu-horizontal p-0"><li><a class="  " href="/Tapadoo-site/tapadoo/about">Tapadoo</a></li><li><a class="  " href="/Tapadoo-site/apps/requisites">Apps</a></li><li><a class="  " href="/Tapadoo-site/blog/1">Blog</a></li></ul></div></header></div><main class="min-h-[70vh] relative"> <div class="p-4 max-w-5xl mx-auto mt-[5vh]"><figure><img src="https://cdn-bhcgp.nitrocdn.com/lQsUIlYWTGkhjqgYKmLJkHSBczAwGDPM/assets/static/optimized/rev-f8d7f54/wp-content/uploads/2018/08/Untitled-design.png.webp" alt="App Performance; Measuring &amp; OptimisationTapadoo blog" class="rounded-xl max-w-[90vw] mx-auto w-full"/></figure><section class="mb-10"><h1 class="app-title my-8">App Performance; Measuring &amp; Optimisation</h1><h3>5<!-- --> date </h3><h3>1<!-- --> day</h3><h3>2018-11-05<!-- --> </h3><div class="categories"><p class="my-4 text-lg font-medium">Tags : </p><p class="p-2 text-xs px-4 bg-neutral rounded-lg inline-block text-gray-100 font-semibold cursor-pointer">development</p></div><div class="w-full bg-neutral h-[1px] my-8 opacity-60"></div><p class="blog-text text-justify">A new client came to us recently with a project that would test our ability on app performance.</p>
<p class="blog-text text-justify">They had a sample iOS app, which loaded a point cloud into a 3D model. They wanted to build a proof of concept app and incorporate this 3D model into it as a nice visual. App performance was important to them.</p>
<p class="blog-text text-justify">We got to work building the app itself. But once we started to integrate the existing 3D model, issues arose. The time it took for the model to load was quite long, nearly 40 seconds and it froze the app at start up. Not a great start for app performance.</p>
<p class="blog-text text-justify">Obviously this wasn&#x27;t good enough, so we set about fixing it. With some tweaks to string handling and parsing, we were able to gain a measurable 16X app performance improvement.</p>
<p class="blog-text text-justify">The code the client brought with them was based on this code on <a class="text-primary " href="https://github.com/eugeneu/PoindCloudRenderer">GitHub.</a> It works by reading in a .ply file containing the x,y,z coordinates of points, then forms a scene kit node from these points. The SceneKit node generated in the sample project looks like this:</p>
<p class="blog-text text-justify"><a class="text-primary " href="https://tapadoo.wpengine.com/wp-content/uploads/2018/08/rotate.gif"><img src="/Tapadoo-site/images/rotate.gif" class="my-3 mx-auto"/></a></p>
<p class="blog-text text-justify">There are a few downsides to this point cloud loader; it’s slow, it makes assumptions on the data in the .ply file, ignores additional data like normals and colours.</p>
<p class="blog-text text-justify">However, the model would not always be known ahead of time and this was a short project. We weren’t going to completely change how the 3D models were stored or loaded on such a tight deadline. So, we decided to see if we could improve this existing code.</p>
<p class="blog-text text-justify">To do this we needed to look at some app measurement techniques in order to improve app performance.</p>
<h2 class="blog-subtitle ">Time to improve app performance</h2>
<p class="blog-text text-justify">Our first task was to speed up this PointCloudRenderer project.</p>
<p class="blog-text text-justify">The meat of this example is the PointCloud class. On initialisation it reads in a ply file (hard coded name), parses the header, then takes each line of data, splits into three parts, and converts each part to a Floating point number. It gathers these floats in an array of structs representing the points.</p>
<p class="blog-text text-justify">Now, we are guessing this is slow, but as the saying goes, you can’t improve what you don’t measure. So before we go fixing anything, let’s first measure its current performance. We’ll also want to see if our changes are making things better as we go.</p>
<p class="blog-text text-justify">It’s a perfect time to use unit tests and Xcode’s measure feature.</p>
<h2 class="blog-subtitle ">Measuring Initial Loading</h2>
<p class="blog-text text-justify">The sample on GitHub ships with a couple of example .ply files, a bunny and a dragon. The bunny only has ~36K points in its data but the dragon has 437,645 points. This is close enough to our clients, which was 532,993 points. We can use the dragon model for our tests as it performed similarly to our client’s model.</p>
<p class="blog-text text-justify">First, we make a small tweak to the PointCloud class, to allow us to specify the name of the model file to load. Then we write a unit test class, as shown below and run it. The measure test block executes the code 10 times and gives an average.</p>
<p class="blog-text text-justify"> </p>
<p class="blog-text text-justify"><a class="text-primary " href="https://tapadoo.wpengine.com/wp-content/uploads/2018/08/initial-times.png"><img src="/Tapadoo-site/images/initial-times.png" class="my-3 mx-auto"/></a></p>
<p class="blog-text text-justify">Running these new tests a few times on an iPad gives us a baseline to work with. The Dragon is taking 36 seconds to load on average.</p>
<p class="blog-text text-justify">We can also run the app under the Time Profiler to get an idea of what parts of the init method are taking so long.</p>
<p class="blog-text text-justify"> </p>
<p class="blog-text text-justify"><a class="text-primary " href="https://tapadoo.wpengine.com/wp-content/uploads/2018/08/profile1.png"><img src="/Tapadoo-site/images/profile1.png" class="my-3 mx-auto"/></a></p>
<p class="blog-text text-justify"><a class="text-primary " href="https://tapadoo.wpengine.com/wp-content/uploads/2018/08/profile2.png"><img src="/Tapadoo-site/images/profile2.png" class="my-3 mx-auto"/></a></p>
<p class="blog-text text-justify">Here&#x27;s the initialization method for PointCloud:</p>
<p class="blog-text text-justify">    init(filename: String = &quot;bun_zipper_points&quot;) {
        super.init()
        
        self.n = 0
        var x, y, z : Double
        (x,y,z) = (0,0,0)
        
        // Open file
        if let path = Bundle.main.path(forResource: filename, ofType: &quot;ply&quot;) {
            do {
                let data = try String(contentsOfFile: path, encoding: .ascii)
                var myStrings = data.components(separatedBy: &quot;\n&quot;)
                
                // Read header
                while !myStrings.isEmpty {
                    let line = myStrings.removeFirst()
                    if line.hasPrefix(&quot;element vertex &quot;) {
                        n = Int(line.components(separatedBy: &quot; &quot;)[2])!
                        continue
                    }
                    if line.hasPrefix(&quot;end_header&quot;) {
                        break
                    }
                }
                
                pointCloud = Array<!-- -->&lt;SCNVector3&gt;<!-- -->(repeating: SCNVector3(x:0,y:0,z:0), count: n)
                
                // Read data
                for i in 0...(self.n-1) {
                    let line = myStrings[i]
                    x = Double(line.components(separatedBy: &quot; &quot;)[0])!
                    y = Double(line.components(separatedBy: &quot; &quot;)[1])!
                    z = Double(line.components(separatedBy: &quot; &quot;)[2])!
                    
                    pointCloud[i].x = Float(x)
                    pointCloud[i].y = Float(y)
                    pointCloud[i].z = Float(z)
                }
                NSLog(&quot;Point cloud data loaded: %d points&quot;,n)
            } catch {
                print(error)
            }
        }
        
    }</p>
<p class="blog-text text-justify">And here’s what the ply file looks like:</p>
<p class="blog-text text-justify">ply
format ascii 1.0
comment VCGLIB generated
element vertex 437645
property float x
property float y
property float z
element face 0
property list uchar int vertex_indices
end_header
0.1791272 -0.2087705 -0.2279476
0.1780086 -0.2087705 -0.2278163
0.1808354 -0.2088217 -0.2278163
0.1808354 -0.2087705 -0.2278363
0.1809296 -0.2087705 -0.2278163
0.1791272 -0.2070623 -0.227975
0.1808354 -0.2070623 -0.2281433
0.1825437 -0.2074703 -0.2278163
0.1825437 -0.2070623 -0.2279193
0.1808354 -0.205354 -0.2280911
[....]</p>
<p class="blog-text text-justify">Hopefully it&#x27;s easy enough to follow.</p>
<p class="blog-text text-justify">It firsts reads the entire file into a String variable. Then it splits the string into lines. Next it reads the start of the .ply file looking for a line containing “element vertex”. This line contains a count of the number of rows of data. Once it knows how many vectors it&#x27;s going to be creating, it creates an array of vectors with values of 0,0,0. Finally, it loops over the remaining lines to parse the X,Y,Z values for the vector.</p>
<h2 class="blog-subtitle ">Reading with sscanf</h2>
<p class="blog-text text-justify">So let’s get to improving things.</p>
<p class="blog-text text-justify">The profiling above, shows that 95% of the time was used on splitting strings with the components method and creating Doubles.</p>
<p class="blog-text text-justify">The biggest use of these is in the loop that creates our vectors. It’s splitting one string into three strings (three times), then creating Doubles, then creating floats from those doubles, then updating a vector struct. This works. It’s readable and if it was only a couple of uses I wouldn’t mind. But it’s happening half a million times in our example. It&#x27;s likely to be wasting time and memory creating new strings at the very least.</p>
<p class="blog-text text-justify">If we replace those calls to split the string, we might end up with something quicker. The first thing that comes to mind when I think of reading three floats from a string is the sscanf function from C. But we are coding in swift here. We can call a scanf function, but it’s a bit uglier. It looks like the following.</p>
<p class="blog-text text-justify"> </p>
<p class="blog-text text-justify">pointCloud.reserveCapacity(n)
var floatBuffer = UnsafeMutablePointer<!-- -->&lt;Float&gt;<!-- -->.allocate(capacity: 3)</p>
<p class="blog-text text-justify">// Read data
for i in 0...(self.n-1) {
    
    let line = myStrings[i]
    
    let vector = withVaList([floatBuffer,floatBuffer.advanced(by: 1),floatBuffer.advanced(by: 2)]) { valList -&gt; SCNVector3 in
        vsscanf(line,&quot;%f %f %f&quot;, valList)
        
        return SCNVector3(x:floatBuffer[0],y:floatBuffer[1],z:floatBuffer[2])
    }
    
    pointCloud.append(vector)
}</p>
<p class="blog-text text-justify"> </p>
<p class="blog-text text-justify">First, we allocate space in our array, and create a buffer for three floats. We will reuse the memory for the floats on each run of the loop, as the creation of the struct will copy their values anyway. Next, we use the withValList function to create a pointer we can pass to the vsscanf function. Once that returns we can now read the three floats from the buffer.</p>
<p class="blog-text text-justify">It runs. The model still looks correct. But is it faster?</p>
<p class="blog-text text-justify">Thankfully we can just rerun our tests on the same hardware.</p>
<p class="blog-text text-justify">The results are promising:</p>
<p class="blog-text text-justify"><a class="text-primary " href="https://tapadoo.wpengine.com/wp-content/uploads/2018/08/attempt1.png"><img src="/Tapadoo-site/images/attempt1.png" class="my-3 mx-auto"/></a></p>
<p class="blog-text text-justify">From 36 seconds to five seconds.</p>
<p class="blog-text text-justify">This is a welcome improvement. We include this change in our proof of concept app and move on for now.</p>
<h2 class="blog-subtitle ">Using NSScanner</h2>
<p class="blog-text text-justify">But our new solution isn’t great.</p>
<p class="blog-text text-justify">Later we get a chance to come back and try to improve things a little more.</p>
<p class="blog-text text-justify">While it’s faster, it’s also more ugly with the unwieldy UnsafeMutableBuffers and valList pointers that swift makes us use there. Our leap back to C style programming may have been the wrong path to take. What we need is a better way to read numbers from a string.</p>
<p class="blog-text text-justify">NSScanner is a Foundation class, which you initialise with a string and can then read number or substrings from it as it moves over the string while skipping the spaces and new lines. It&#x27;s exactly what we need here. Rewriting our loop again, it now looks like this:</p>
<p class="blog-text text-justify">pointCloud.reserveCapacity(n)</p>
<p class="blog-text text-justify">var x: Float = 0
var y: Float = 0
var z: Float = 0
// Read data
for i in 0 ..&lt; n {
    let scanner = Scanner(string: myStrings[i])
    scanner.scanFloat(&amp;x)
    scanner.scanFloat(&amp;y)
    scanner.scanFloat(&amp;z)
    
    let vector = SCNVector3(x: x , y: y, z: z)
    pointCloud.append(vector)
}</p>
<p class="blog-text text-justify"> </p>
<p class="blog-text text-justify">OK, that reads much nicer. In fact, it even reads nicer than the original code.</p>
<p class="blog-text text-justify">But what are the chances it’s faster?</p>
<p class="blog-text text-justify">Lets run our tests and find out.</p>
<p class="blog-text text-justify"><a class="text-primary " href="https://tapadoo.wpengine.com/wp-content/uploads/2018/08/attempt2.png"><img src="/Tapadoo-site/images/attempt2.png" class="my-3 mx-auto"/></a></p>
<p class="blog-text text-justify">Even better again. From 36 seconds to three, it’s an order of magnitude better. It’s running in less than a tenth of the time it originally took.</p>
<p class="blog-text text-justify">Before running the test, part of me was expecting a worse performance. This highlights the importance of measuring your improvements as you go. If both code snippets were shown to me and I was asked to choose the fastest, I probably would have chosen the scanf version as it looked closer to C.</p>
<h2 class="blog-subtitle ">A Single Scanner</h2>
<p class="blog-text text-justify">There is still potential here for more improvements. One thing that&#x27;s still happening in our initialisation function, is excessive string manipulation. The entire file is read into a String initially but then it&#x27;s split by line into an array of lines. Then we are removing lines from the array as we search for the number of points, until we reach the end of the header.</p>
<p class="blog-text text-justify">If we can cut out these additional strings and the array manipulation we could see further improvements.</p>
<p class="blog-text text-justify">While there&#x27;s nothing wrong with handling each line of the header, we aren’t actually using any of them. We are only hunting for one specific value. Also, as we loop over all the remaining lines we are creating a new Scanner for each line.</p>
<p class="blog-text text-justify">What if we could instead extract the point count from the string without splitting the lines into an array. And then use one scanner for the entire set of vertex data.</p>
<p class="blog-text text-justify">We can find the parts of the header we are interested in using the range and substring methods on String. Substrings in swift do not take up extra memory.</p>
<p class="blog-text text-justify">Here is our new init method with these changes:</p>
<p class="blog-text text-justify">init(filename: String = &quot;bun_zipper_points&quot;) {
    super.init()
    
    // Open file
    if let path = Bundle.main.path(forResource: filename, ofType: &quot;ply&quot;) {
        do {
            let data = try String(contentsOfFile: path, encoding: .ascii)
            
            //Without a header, we dont know our point count
            guard let headerEndRange = data.range(of: &quot;end_header&quot;) else {return }
            
            //We need to extract the point count from the header. Lets get the header as a substring to work with
            let headerSubString = data[data.startIndex ... headerEndRange.upperBound]
            
            guard let elementVertexRange = headerSubString.range(of: &quot;element vertex &quot;) else {return }
            
            //This is the substring container the number followed by the rest of the header
            let vertexCountParialString = headerSubString.suffix(from: elementVertexRange.upperBound)
            
            //Find the next line break and create a substring with just the vertex count
            let vertexEndIndex = vertexCountParialString.index(of: &quot;\n&quot;) ?? vertexCountParialString.endIndex
            let vertexCountString = vertexCountParialString[..&lt;vertexEndIndex]
            
            n = Int(vertexCountString) ?? 0
            
            pointCloud.reserveCapacity(n)
            
            var x: Float = 0
            var y: Float = 0
            var z: Float = 0
            
            let pointStartIndex = headerEndRange.upperBound
            
            let pointDataSubString = data[pointStartIndex...]</p>
<p class="blog-text text-justify">            let dataScanner = Scanner(string: String(pointDataSubString))
            
            // Read data
            for _ in 0 ..&lt; n {</p>
<p class="blog-text text-justify">                dataScanner.scanFloat(&amp;x)
                dataScanner.scanFloat(&amp;y)
                dataScanner.scanFloat(&amp;z)
                
                //bunny model for example has extra data for normals and color. lets ignore anything but the first 3 floats for now by skipping the rest of the line
                dataScanner.scanUpToCharacters(from: CharacterSet.newlines, into: nil)
                
                let vector = SCNVector3(x: x , y: y, z: z)
                pointCloud.append(vector)
            }
            NSLog(&quot;Point cloud data loaded: %d points&quot;, n)
        } catch {
            print(error)
        }
    }
    
}</p>
<p class="blog-text text-justify">We create a substring for the header, which is more efficient to work with than splitting the string. Then we find the range of the element vertex text we were previously searching for. Once we find that, we can extract the rest of the line and convert it to an Int for our point count. Next, we get the substring containing just the lines of data we need to parse and create a single Scanner that we use in our data parsing loop.</p>
<p class="blog-text text-justify">Just hunting for one value in the header isn’t great but it’s all we need. A better ply parser might correctly scan the full header here to determine exactly how many properties to read on each data line and the type of data. But for our proof of concept app we don’t need that, so we skip straight to the values we are interested in.</p>
<p class="blog-text text-justify">Once again, our tests can reveal if we are heading in the right direction or not:</p>
<p class="blog-text text-justify"><a class="text-primary " href="https://tapadoo.wpengine.com/wp-content/uploads/2018/08/attempt3.png"><img src="/Tapadoo-site/images/attempt3.png" class="my-3 mx-auto"/></a></p>
<p class="blog-text text-justify">The dragon is down to 2.2 seconds, a further improvement.</p>
<p class="blog-text text-justify">So, with some refactoring of string handling and parsing and some XCTests to help us measure and repeatedly test, we’ve taken the parsing of the dragon sample file from 36 seconds, to 2.2 seconds.</p>
<p class="blog-text text-justify">94% better.</p>
<p class="blog-text text-justify">Over 16 times faster.</p>
<p class="blog-text text-justify">Its tempting to keep going - there’s undoubtedly more savings to be had but this will do for now.</p>
<p class="blog-text text-justify">The original code can be found on <a class="text-primary " href="https://github.com/eugeneu/PoindCloudRenderer">GitHub</a>, it was published with a GPL License. A version with the final improvements shown here can be found here : <a class="text-primary " href="https://github.com/Tapadoo/PoindCloudRenderer">https://github.com/Tapadoo/PoindCloudRenderer</a></p>
<p class="blog-text text-justify">You can also <a class="text-primary " href="https://tapadoo.wpengine.com/contact/">get in touch</a> with us if you need help with developing your app.</p>
<p class="blog-text text-justify">Jason Connery</p>
<p class="blog-text text-justify">Lead iOS Developer</p></section></div> </main><footer class="p-10 bg-[#eeeeee90] text-[#A09893] "><div class="app-container footer"><div><img src="/Tapadoo-site/_next/static/media/tapadoo-large-logo.b51a8a63.png" alt="Tapadoo logo" class="w-full max-w-[120px] cursor-pointer grayscale"/><div class="my-4"><a href="https://goo.gl/maps/8Q1WtLmA8t41bNnJ6"><p aria-label="Tapadoo location" class="my-2">26-28 Strand Street Great, Dublin 1 </p></a><a href="mailto:enquiries@tapadoo.com "><p aria-label="Tapadoo mail" class="">enquiries@tapadoo.com </p></a></div><a href="tel:+353 1 555 222 4"><p aria-label="Tapadoo Phone" class="">+353 1 555 222 4</p></a></div><div><span class="footer-title">Links</span><a class="link link-hover" href="/Tapadoo-site/tapadoo/contact">Privacy Policy</a></div><div><span class="footer-title">Company</span><a class="link link-hover" href="/Tapadoo-site/tapadoo/about">About us</a><a class="link link-hover" href="/Tapadoo-site/tapadoo/careers">Careers</a><a class="link link-hover" href="/Tapadoo-site/apps/costs">Pricing</a><a class="link link-hover" href="/Tapadoo-site/blog/1">Blog</a></div></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"App Performance; Measuring \u0026 Optimisation","date":"2018-11-05","content":"\nA new client came to us recently with a project that would test our ability on app performance.\n\nThey had a sample iOS app, which loaded a point cloud into a 3D model. They wanted to build a proof of concept app and incorporate this 3D model into it as a nice visual. App performance was important to them.\n\nWe got to work building the app itself. But once we started to integrate the existing 3D model, issues arose. The time it took for the model to load was quite long, nearly 40 seconds and it froze the app at start up. Not a great start for app performance.\n\nObviously this wasn't good enough, so we set about fixing it. With some tweaks to string handling and parsing, we were able to gain a measurable 16X app performance improvement.\n\nThe code the client brought with them was based on this code on [GitHub.](https://github.com/eugeneu/PoindCloudRenderer) It works by reading in a .ply file containing the x,y,z coordinates of points, then forms a scene kit node from these points. The SceneKit node generated in the sample project looks like this:\n\n[![](images/rotate.gif)](https://tapadoo.wpengine.com/wp-content/uploads/2018/08/rotate.gif)\n\nThere are a few downsides to this point cloud loader; it’s slow, it makes assumptions on the data in the .ply file, ignores additional data like normals and colours.\n\nHowever, the model would not always be known ahead of time and this was a short project. We weren’t going to completely change how the 3D models were stored or loaded on such a tight deadline. So, we decided to see if we could improve this existing code.\n\nTo do this we needed to look at some app measurement techniques in order to improve app performance.\n\n## Time to improve app performance\n\nOur first task was to speed up this PointCloudRenderer project.\n\nThe meat of this example is the PointCloud class. On initialisation it reads in a ply file (hard coded name), parses the header, then takes each line of data, splits into three parts, and converts each part to a Floating point number. It gathers these floats in an array of structs representing the points.\n\nNow, we are guessing this is slow, but as the saying goes, you can’t improve what you don’t measure. So before we go fixing anything, let’s first measure its current performance. We’ll also want to see if our changes are making things better as we go.\n\nIt’s a perfect time to use unit tests and Xcode’s measure feature.\n\n## Measuring Initial Loading\n\nThe sample on GitHub ships with a couple of example .ply files, a bunny and a dragon. The bunny only has ~36K points in its data but the dragon has 437,645 points. This is close enough to our clients, which was 532,993 points. We can use the dragon model for our tests as it performed similarly to our client’s model.\n\nFirst, we make a small tweak to the PointCloud class, to allow us to specify the name of the model file to load. Then we write a unit test class, as shown below and run it. The measure test block executes the code 10 times and gives an average.\n\n \n\n[![](images/initial-times.png)](https://tapadoo.wpengine.com/wp-content/uploads/2018/08/initial-times.png)\n\nRunning these new tests a few times on an iPad gives us a baseline to work with. The Dragon is taking 36 seconds to load on average.\n\nWe can also run the app under the Time Profiler to get an idea of what parts of the init method are taking so long.\n\n \n\n[![](images/profile1.png)](https://tapadoo.wpengine.com/wp-content/uploads/2018/08/profile1.png)\n\n[![](images/profile2.png)](https://tapadoo.wpengine.com/wp-content/uploads/2018/08/profile2.png)\n\nHere's the initialization method for PointCloud:\n\n    init(filename: String = \"bun\\_zipper\\_points\") {\n        super.init()\n        \n        self.n = 0\n        var x, y, z : Double\n        (x,y,z) = (0,0,0)\n        \n        // Open file\n        if let path = Bundle.main.path(forResource: filename, ofType: \"ply\") {\n            do {\n                let data = try String(contentsOfFile: path, encoding: .ascii)\n                var myStrings = data.components(separatedBy: \"\\\\n\")\n                \n                // Read header\n                while !myStrings.isEmpty {\n                    let line = myStrings.removeFirst()\n                    if line.hasPrefix(\"element vertex \") {\n                        n = Int(line.components(separatedBy: \" \")\\[2\\])!\n                        continue\n                    }\n                    if line.hasPrefix(\"end\\_header\") {\n                        break\n                    }\n                }\n                \n                pointCloud = Array\u003cSCNVector3\u003e(repeating: SCNVector3(x:0,y:0,z:0), count: n)\n                \n                // Read data\n                for i in 0...(self.n-1) {\n                    let line = myStrings\\[i\\]\n                    x = Double(line.components(separatedBy: \" \")\\[0\\])!\n                    y = Double(line.components(separatedBy: \" \")\\[1\\])!\n                    z = Double(line.components(separatedBy: \" \")\\[2\\])!\n                    \n                    pointCloud\\[i\\].x = Float(x)\n                    pointCloud\\[i\\].y = Float(y)\n                    pointCloud\\[i\\].z = Float(z)\n                }\n                NSLog(\"Point cloud data loaded: %d points\",n)\n            } catch {\n                print(error)\n            }\n        }\n        \n    }\n\nAnd here’s what the ply file looks like:\n\nply\nformat ascii 1.0\ncomment VCGLIB generated\nelement vertex 437645\nproperty float x\nproperty float y\nproperty float z\nelement face 0\nproperty list uchar int vertex\\_indices\nend\\_header\n0.1791272 -0.2087705 -0.2279476\n0.1780086 -0.2087705 -0.2278163\n0.1808354 -0.2088217 -0.2278163\n0.1808354 -0.2087705 -0.2278363\n0.1809296 -0.2087705 -0.2278163\n0.1791272 -0.2070623 -0.227975\n0.1808354 -0.2070623 -0.2281433\n0.1825437 -0.2074703 -0.2278163\n0.1825437 -0.2070623 -0.2279193\n0.1808354 -0.205354 -0.2280911\n\\[....\\]\n\nHopefully it's easy enough to follow.\n\nIt firsts reads the entire file into a String variable. Then it splits the string into lines. Next it reads the start of the .ply file looking for a line containing “element vertex”. This line contains a count of the number of rows of data. Once it knows how many vectors it's going to be creating, it creates an array of vectors with values of 0,0,0. Finally, it loops over the remaining lines to parse the X,Y,Z values for the vector.\n\n## Reading with sscanf\n\nSo let’s get to improving things.\n\nThe profiling above, shows that 95% of the time was used on splitting strings with the components method and creating Doubles.\n\nThe biggest use of these is in the loop that creates our vectors. It’s splitting one string into three strings (three times), then creating Doubles, then creating floats from those doubles, then updating a vector struct. This works. It’s readable and if it was only a couple of uses I wouldn’t mind. But it’s happening half a million times in our example. It's likely to be wasting time and memory creating new strings at the very least.\n\nIf we replace those calls to split the string, we might end up with something quicker. The first thing that comes to mind when I think of reading three floats from a string is the sscanf function from C. But we are coding in swift here. We can call a scanf function, but it’s a bit uglier. It looks like the following.\n\n \n\npointCloud.reserveCapacity(n)\nvar floatBuffer = UnsafeMutablePointer\u003cFloat\u003e.allocate(capacity: 3)\n\n// Read data\nfor i in 0...(self.n-1) {\n    \n    let line = myStrings\\[i\\]\n    \n    let vector = withVaList(\\[floatBuffer,floatBuffer.advanced(by: 1),floatBuffer.advanced(by: 2)\\]) { valList -\u003e SCNVector3 in\n        vsscanf(line,\"%f %f %f\", valList)\n        \n        return SCNVector3(x:floatBuffer\\[0\\],y:floatBuffer\\[1\\],z:floatBuffer\\[2\\])\n    }\n    \n    pointCloud.append(vector)\n}\n\n \n\nFirst, we allocate space in our array, and create a buffer for three floats. We will reuse the memory for the floats on each run of the loop, as the creation of the struct will copy their values anyway. Next, we use the withValList function to create a pointer we can pass to the vsscanf function. Once that returns we can now read the three floats from the buffer.\n\nIt runs. The model still looks correct. But is it faster?\n\nThankfully we can just rerun our tests on the same hardware.\n\nThe results are promising:\n\n[![](images/attempt1.png)](https://tapadoo.wpengine.com/wp-content/uploads/2018/08/attempt1.png)\n\nFrom 36 seconds to five seconds.\n\nThis is a welcome improvement. We include this change in our proof of concept app and move on for now.\n\n## Using NSScanner\n\nBut our new solution isn’t great.\n\nLater we get a chance to come back and try to improve things a little more.\n\nWhile it’s faster, it’s also more ugly with the unwieldy UnsafeMutableBuffers and valList pointers that swift makes us use there. Our leap back to C style programming may have been the wrong path to take. What we need is a better way to read numbers from a string.\n\nNSScanner is a Foundation class, which you initialise with a string and can then read number or substrings from it as it moves over the string while skipping the spaces and new lines. It's exactly what we need here. Rewriting our loop again, it now looks like this:\n\npointCloud.reserveCapacity(n)\n\nvar x: Float = 0\nvar y: Float = 0\nvar z: Float = 0\n// Read data\nfor i in 0 ..\u003c n {\n    let scanner = Scanner(string: myStrings\\[i\\])\n    scanner.scanFloat(\u0026x)\n    scanner.scanFloat(\u0026y)\n    scanner.scanFloat(\u0026z)\n    \n    let vector = SCNVector3(x: x , y: y, z: z)\n    pointCloud.append(vector)\n}\n\n \n\nOK, that reads much nicer. In fact, it even reads nicer than the original code.\n\nBut what are the chances it’s faster?\n\nLets run our tests and find out.\n\n[![](images/attempt2.png)](https://tapadoo.wpengine.com/wp-content/uploads/2018/08/attempt2.png)\n\nEven better again. From 36 seconds to three, it’s an order of magnitude better. It’s running in less than a tenth of the time it originally took.\n\nBefore running the test, part of me was expecting a worse performance. This highlights the importance of measuring your improvements as you go. If both code snippets were shown to me and I was asked to choose the fastest, I probably would have chosen the scanf version as it looked closer to C.\n\n## A Single Scanner\n\nThere is still potential here for more improvements. One thing that's still happening in our initialisation function, is excessive string manipulation. The entire file is read into a String initially but then it's split by line into an array of lines. Then we are removing lines from the array as we search for the number of points, until we reach the end of the header.\n\nIf we can cut out these additional strings and the array manipulation we could see further improvements.\n\nWhile there's nothing wrong with handling each line of the header, we aren’t actually using any of them. We are only hunting for one specific value. Also, as we loop over all the remaining lines we are creating a new Scanner for each line.\n\nWhat if we could instead extract the point count from the string without splitting the lines into an array. And then use one scanner for the entire set of vertex data.\n\nWe can find the parts of the header we are interested in using the range and substring methods on String. Substrings in swift do not take up extra memory.\n\nHere is our new init method with these changes:\n\ninit(filename: String = \"bun\\_zipper\\_points\") {\n    super.init()\n    \n    // Open file\n    if let path = Bundle.main.path(forResource: filename, ofType: \"ply\") {\n        do {\n            let data = try String(contentsOfFile: path, encoding: .ascii)\n            \n            //Without a header, we dont know our point count\n            guard let headerEndRange = data.range(of: \"end\\_header\") else {return }\n            \n            //We need to extract the point count from the header. Lets get the header as a substring to work with\n            let headerSubString = data\\[data.startIndex ... headerEndRange.upperBound\\]\n            \n            guard let elementVertexRange = headerSubString.range(of: \"element vertex \") else {return }\n            \n            //This is the substring container the number followed by the rest of the header\n            let vertexCountParialString = headerSubString.suffix(from: elementVertexRange.upperBound)\n            \n            //Find the next line break and create a substring with just the vertex count\n            let vertexEndIndex = vertexCountParialString.index(of: \"\\\\n\") ?? vertexCountParialString.endIndex\n            let vertexCountString = vertexCountParialString\\[..\u003cvertexEndIndex\\]\n            \n            n = Int(vertexCountString) ?? 0\n            \n            pointCloud.reserveCapacity(n)\n            \n            var x: Float = 0\n            var y: Float = 0\n            var z: Float = 0\n            \n            let pointStartIndex = headerEndRange.upperBound\n            \n            let pointDataSubString = data\\[pointStartIndex...\\]\n\n            let dataScanner = Scanner(string: String(pointDataSubString))\n            \n            // Read data\n            for \\_ in 0 ..\u003c n {\n\n                dataScanner.scanFloat(\u0026x)\n                dataScanner.scanFloat(\u0026y)\n                dataScanner.scanFloat(\u0026z)\n                \n                //bunny model for example has extra data for normals and color. lets ignore anything but the first 3 floats for now by skipping the rest of the line\n                dataScanner.scanUpToCharacters(from: CharacterSet.newlines, into: nil)\n                \n                let vector = SCNVector3(x: x , y: y, z: z)\n                pointCloud.append(vector)\n            }\n            NSLog(\"Point cloud data loaded: %d points\", n)\n        } catch {\n            print(error)\n        }\n    }\n    \n}\n\nWe create a substring for the header, which is more efficient to work with than splitting the string. Then we find the range of the element vertex text we were previously searching for. Once we find that, we can extract the rest of the line and convert it to an Int for our point count. Next, we get the substring containing just the lines of data we need to parse and create a single Scanner that we use in our data parsing loop.\n\nJust hunting for one value in the header isn’t great but it’s all we need. A better ply parser might correctly scan the full header here to determine exactly how many properties to read on each data line and the type of data. But for our proof of concept app we don’t need that, so we skip straight to the values we are interested in.\n\nOnce again, our tests can reveal if we are heading in the right direction or not:\n\n[![](images/attempt3.png)](https://tapadoo.wpengine.com/wp-content/uploads/2018/08/attempt3.png)\n\nThe dragon is down to 2.2 seconds, a further improvement.\n\nSo, with some refactoring of string handling and parsing and some XCTests to help us measure and repeatedly test, we’ve taken the parsing of the dragon sample file from 36 seconds, to 2.2 seconds.\n\n94% better.\n\nOver 16 times faster.\n\nIts tempting to keep going - there’s undoubtedly more savings to be had but this will do for now.\n\nThe original code can be found on [GitHub](https://github.com/eugeneu/PoindCloudRenderer), it was published with a GPL License. A version with the final improvements shown here can be found here : [https://github.com/Tapadoo/PoindCloudRenderer](https://github.com/Tapadoo/PoindCloudRenderer)\n\nYou can also [get in touch](https://tapadoo.wpengine.com/contact/) with us if you need help with developing your app.\n\nJason Connery\n\nLead iOS Developer\n","postImage":"https://cdn-bhcgp.nitrocdn.com/lQsUIlYWTGkhjqgYKmLJkHSBczAwGDPM/assets/static/optimized/rev-f8d7f54/wp-content/uploads/2018/08/Untitled-design.png.webp","categories":["development"]}},"__N_SSG":true},"page":"/blog/post/[slug]","query":{"slug":"app-performance-measuring-optimisation"},"buildId":"TlZmfFUIyTMTk-qJxhjn1","assetPrefix":"/Tapadoo-site","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>